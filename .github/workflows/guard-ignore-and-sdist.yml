name: guard-ignore-and-sdist
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}
permissions:
  contents: read
concurrency:
  group: guard-ignore-and-sdist-${{ github.ref }}
  cancel-in-progress: true
jobs:
  guard:
    name: guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check .gitignore contains required patterns
        shell: bash
        run: |
          set -euo pipefail
          req=0
          grep -E '(^|/)zz-out(/|/|\*\*)?' .gitignore >/dev/null 2>&1 || { echo "::error::.gitignore doit ignorer zz-out/**"; req=1; }
          grep -E '(^|/)_attic_untracked(/|/|\*\*)?' .gitignore >/dev/null 2>&1 || { echo "::error::.gitignore doit ignorer _attic_untracked/**"; req=1; }
          [ $req -eq 0 ] || exit 1
          echo "[OK] .gitignore couvre zz-out/** et _attic_untracked/**"

      - name: Build sdist
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip build >/dev/null
          python3 -m build --sdist
          ls -lh dist/*.tar.gz

      - name: Inspect sdist for forbidden artefacts
        shell: bash
        run: |
          set -euo pipefail
          TARBALL="$(ls dist/*.tar.gz | head -n1)"
          echo "[INFO] Inspect: $TARBALL"
          tar -tzf "$TARBALL" > sdist.lst
          if grep -E '(^|/)zz-out/|(^|/)_attic_untracked/|/__pycache__/|\.py[co]$|\.tmp$|\.log$|\.save$|\.bak($|[^/])|\.autofix\..*\.bak' sdist.lst; then
            echo "::error::Artefacts interdits détectés dans la sdist."
            exit 1
          fi
          echo "[OK] sdist propre"
