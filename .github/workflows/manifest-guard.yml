name: manifest-guard
on:
  workflow_dispatch: {}
  push:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"
  pull_request:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

concurrency:
  group: manifest-guard-${{ github.ref }}
  cancel-in-progress: false

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set HARD_FAIL_CODES by branch
        run: |
          # Défaut : FILE_MISSING, JSON_INVALID (SCHEMA_INVALID = warn)
          HARD="FILE_MISSING,JSON_INVALID"
          # Sur branches de publication, on ajoute SCHEMA_INVALID comme bloquant
          if [[ "${GITHUB_REF:-}" =~ ^refs/heads/(main|release/) || "${GITHUB_REF:-}" =~ ^refs/tags/ ]]; then
            HARD="FILE_MISSING,JSON_INVALID,SCHEMA_INVALID"
          fi
          echo "HARD_FAIL_CODES=$HARD" >> "$GITHUB_ENV"

      - name: Locate manifest (non-bloquant)
        id: loc
        run: |
          M=zz-manifests/manifest_master.json
          if [[ -f "$M" ]]; then echo "manifest=$M" >> "$GITHUB_OUTPUT"; else echo "::warning::MANIFEST_MISSING $M"; fi

      - name: Produce diag_report.json (validate)
        run: |
          python3 zz-tools/validate_manifest.py "${{ steps.loc.outputs.manifest || 'zz-manifests/manifest_master.json' }}" > diag_report.json

      - name: Post-process report (python → WARN/ERROR)
        id: pp
        env:
          ALLOW_MISSING_REGEX: '(\.lock\.json$|^zz-data/chapter0[8-9]/|^zz-data/chapter10/)'
          SOFT_PASS_IF_ONLY_CODES_REGEX: '^(FILE_MISSING|MANIFEST_MISSING)$'
          HARD_FAIL_CODES: "${{ env.HARD_FAIL_CODES }}"
        run: |
          python3 zz-tools/manifest_postprocess.py
          echo "outcome=$?" >> "$GITHUB_OUTPUT"

      - name: Job summary
        if: always()
        run: |
          echo "### manifest-guard summary" >> $GITHUB_STEP_SUMMARY
          echo "- HARD_FAIL_CODES: \`${HARD_FAIL_CODES}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${GITHUB_REF}\`" >> $GITHUB_STEP_SUMMARY
          echo "\n\`\`\`json" >> $GITHUB_STEP_SUMMARY
          jq . diag_report.json >> $GITHUB_STEP_SUMMARY || echo '{"issues":[]}' >> $GITHUB_STEP_SUMMARY
          echo "\n\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload diag_report.json
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manifest-guard-${{ github.run_id }}
          path: diag_report.json
          retention-days: 7

      - name: Fail on hard errors only
        if: ${{ steps.pp.outcome == '1' }}
        run: |
          echo "Hard errors detected by postprocess → failing job."
          exit 1
