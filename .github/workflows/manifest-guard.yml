name: manifest-guard
on:
  workflow_dispatch: {}
  push:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"
  pull_request:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

concurrency:
  group: manifest-guard-${{ github.ref }}
  cancel-in-progress: false

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set HARD_FAIL_CODES by branch
        id: branch
        run: |
          set -Eeuo pipefail
          ref="${GITHUB_REF#refs/heads/}"
          if [[ "$ref" == "main" || "$ref" =~ ^release/ ]]; then
            echo "HARD_FAIL_CODES=JSON_INVALID,SCHEMA_INVALID" >> "$GITHUB_ENV"
          else
            echo "HARD_FAIL_CODES=" >> "$GITHUB_ENV"
          fi

      - name: Locate manifest (only authority files)
        id: locate
        run: |
          set -Eeuo pipefail
          MANIFS=()
          for m in zz-manifests/manifest_master.json zz-manifests/manifest_publication.json; do
            [[ -f "$m" ]] && MANIFS+=("$m")
          done
          printf '%s\n' "${MANIFS[@]}" | sed 's/^/[loc]/' || true
          printf '%s\0' "${MANIFS[@]}" > manif.list
          echo "count=${#MANIFS[@]}" >> "$GITHUB_OUTPUT"

      - name: Produce diag_report.json (validate)
        run: |
          set -Eeuo pipefail
          echo '{"issues":[]}' > diag_report.json
          if [[ -s manif.list ]]; then
            python3 - <<'PY'
import json,subprocess
issues=[]
with open("manif.list","rb") as f:
    for raw in f.read().split(b'\0'):
        p=raw.decode().strip()
        if not p: continue
        try:
            out=subprocess.check_output(["python3","zz-tools/validate_manifest.py",p],stderr=subprocess.STDOUT)
            j=json.loads(out.decode())
            issues.extend(j.get("issues",[]))
        except subprocess.CalledProcessError as e:
            try:
                j=json.loads(e.output.decode())
                issues.extend(j.get("issues",[]))
            except Exception:
                issues.append({"code":"JSON_INVALID","path":p,"severity":"ERROR","message":"validator crashed"})
json.dump({"issues":issues},open("diag_report.json","w"))
PY
          fi
          jq -r '.issues|length as $n | "[info] issues="+($n|tostring)' diag_report.json || true

      - name: Post-process report (python → WARN/ERROR)
        id: pp
        env:
          HARD_FAIL_CODES: ${{ env.HARD_FAIL_CODES }}
          SOFT_PASS_IF_ONLY_CODES_REGEX: '^(FILE_MISSING|MANIFEST_MISSING|SCHEMA_INVALID)$'
          IGNORE_PATHS_REGEX: '^zz-manifests/(?!manifest_(master|publication)\.json).+'
        run: python3 zz-tools/manifest_postprocess.py

      - name: Job summary
        run: |
          echo "### manifest-guard — résumé" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.issues[] | "- **\(.severity)** \(.code) at \(.path): \(.message)"' diag_report.json | head -200 >> "$GITHUB_STEP_SUMMARY" || true

      - name: Upload diag_report.json
        uses: actions/upload-artifact@v4
        with:
          name: manifest-guard-${{ github.run_id }}
          path: diag_report.json
          retention-days: 7

      - name: Fail on hard errors only
        if: ${{ steps.pp.outcome == 'failure' }}
        run: |
          echo "Hard errors detected by postprocess → failing job."
          exit 1
