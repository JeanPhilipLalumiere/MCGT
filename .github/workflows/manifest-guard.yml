name: manifest-guard
on:
  workflow_dispatch: {}
  push:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"
  pull_request:
    branches: [ "main", "release/**" ]
    paths:
      - "zz-manifests/**"
      - "zz-tools/**"
      - ".github/workflows/manifest-guard.yml"

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

concurrency:
  group: manifest-guard-${{ github.ref }}
  cancel-in-progress: false

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Set HARD_FAIL_CODES by branch
        id: branch
        run: |
          set -Eeuo pipefail
          ref="${GITHUB_REF#refs/heads/}"
          if [[ "$ref" == "main" || "$ref" =~ ^release/ ]]; then
            echo "HARD_FAIL_CODES=JSON_INVALID,SCHEMA_INVALID" >> "$GITHUB_ENV"
          else
            echo "HARD_FAIL_CODES=" >> "$GITHUB_ENV"
          fi

      - name: Locate manifests & validate (produce diag_report.json)
        run: python3 zz-tools/guard_runner.py

      - name: Post-process report (python → WARN/ERROR)
        id: pp
        env:
          HARD_FAIL_CODES: ${{ env.HARD_FAIL_CODES }}
          SOFT_PASS_IF_ONLY_CODES_REGEX: '^(FILE_MISSING|MANIFEST_MISSING|SCHEMA_INVALID)$'
          IGNORE_PATHS_REGEX: '^zz-manifests/(?!manifest_(master|publication)\.json).+'
        run: python3 zz-tools/manifest_postprocess.py

      - name: Job summary
        run: |
          echo "### manifest-guard — résumé" >> "$GITHUB_STEP_SUMMARY"
          jq -r '.issues[] | "- **\(.severity)** \(.code) at \(.path): \(.message)"' diag_report.json | head -200 >> "$GITHUB_STEP_SUMMARY" || true

      - name: Upload diag_report.json
        uses: actions/upload-artifact@v4
        with:
          name: manifest-guard-${{ github.run_id }}
          path: diag_report.json
          retention-days: 7

      - name: Fail on hard errors only
        if: ${{ steps.pp.outcome == 'failure' }}
        run: |
          echo "Hard errors detected by postprocess → failing job."
          exit 1
