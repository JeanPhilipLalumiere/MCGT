name: manifest-guard
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}
permissions:
  contents: read
concurrency:
  group: manifest-guard-${{ github.ref }}
  cancel-in-progress: true
jobs:
  guard:
    name: guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check manifest presence
        shell: bash
        run: |
          set -euo pipefail
          test -f zz-manifests/manifest_master.json || { echo "::error::zz-manifests/manifest_master.json manquant"; exit 1; }
          echo "[OK] manifest présent"
      - name: Validate JSON syntax (python stdlib)
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
import json,sys
p="zz-manifests/manifest_master.json"
with open(p,'rb') as f: json.load(f)
print("JSON OK:", p)
PY
      - name: Optional diag_consistency.py if present
        shell: bash
        run: |
          set -euo pipefail
          if [ -f zz-scripts/diag_consistency.py ]; then
            python3 zz-scripts/diag_consistency.py || { echo "::error::diag_consistency a échoué"; exit 1; }
          else
            echo "[SKIP] zz-scripts/diag_consistency.py absent"
          fi
