# CHAPITRE 5 — GUIDE D’UTILISATION
Nucléosynthèse primordiale (BBN)

Ce guide décrit, de façon opérationnelle, la génération des données et des figures,
ainsi que la compilation LaTeX pour le **Chapitre 5 – Nucléosynthèse primordiale**
du projet MCGT. Le texte est en français; les noms de fichiers et de scripts restent
en anglais pour la cohérence globale du dépôt.

-------------------------------------------------------------------------------
## 1. Objet et périmètre

Ce chapitre met en place un pipeline simplifié de **nucléosynthèse primordiale** (BBN)
qui :

- lit un ensemble de **jalons observationnels** pour D/H et Yp ;
- calcule des prédictions modèles sur une grille temporelle T (Gyr) ;
- construit des **invariants adimensionnels** associés ;
- évalue une fonction **χ²(T)** et sa dérivée lissée ;
- produit un ensemble de **figures** prêtes à intégrer dans le manuscrit LaTeX.

Les résultats doivent permettre une comparaison cohérente **modèle vs observations**
et fournir des diagnostics graphiques (réseau de réactions, D/H, Yp, χ²).

-------------------------------------------------------------------------------
## 2. Organisation des fichiers

### 2.1 Sources LaTeX (`05-nucleosynthese-primordiale/`)

- `05_primordial_nucleosynthesis_conceptual.tex`
- `05_primordial_nucleosynthesis_details.tex`
- `CHAPTER05_GUIDE.txt` (présent fichier guide)

### 2.2 Données (`zz-data/chapter05/`)

- `05_bbn_milestones.csv`
- `05_bbn_grid.csv`
- `05_bbn_data.csv`
- `05_bbn_invariants.csv`
- `05_bbn_params.json`
- `05_chi2_bbn_vs_T.csv`
- `05_dchi2_vs_T.csv`

### 2.3 Figures (`zz-figures/chapter05/`)

- `05_fig_01_bbn_reaction_network.png`
- `05_fig_02_dh_model_vs_obs.png`
- `05_fig_03_yp_model_vs_obs.png`
- `05_fig_04_chi2_vs_t.png`

### 2.4 Scripts (`zz-scripts/chapter05/`)

- `generate_data_chapter05.py`
- `plot_fig01_bbn_reaction_network.py`
- `plot_fig02_dh_model_vs_obs.py`
- `plot_fig03_yp_model_vs_obs.py`
- `plot_fig04_chi2_vs_T.py`
- `requirements.txt`

-------------------------------------------------------------------------------
## 3. Données d’entrée (tables normalisées)

Cette section décrit les **entrées logiques** du pipeline BBN. Plusieurs fichiers
sont générés par le script principal mais servent ensuite d’entrées standardisées
pour la suite des analyses et pour d’autres chapitres.

### 3.1 Jalons observationnels — `05_bbn_milestones.csv`

Chemin : `zz-data/chapter05/05_bbn_milestones.csv`

| Colonne | Description                                        | Unité | Remarques                                  |
|:--------|:---------------------------------------------------|:------|:-------------------------------------------|
| label   | Identifiant du jalon (par ex. `DH_obs`, `Yp_obs`)  | —     | Unique par ligne                           |
| z       | Redshift de référence                              | —     | Peut être NaN si non utilisé               |
| value   | Valeur observée (D/H ou Yp)                        | —     | Valeur numérique flottante                 |
| sigma   | Incertitude publiée                                | —     | Utilisée dans le calcul de χ²              |
| source  | Référence ou note synthétique                      | —     | Chaîne courte, éviter les virgules         |
| classe  | `primary` / `order2`                               | —     | Sur la base des tolérances (1 %, 10 %)     |

- Format : CSV, séparateur virgule, encodage UTF‑8, première ligne = en‑tête.
- Aucune duplication autorisée sur `(label)`.
- Les lignes où `value` ou `sigma` ne sont pas parsables en float sont ignorées
  ou provoquent une erreur explicite selon la configuration.

### 3.2 Grille temporelle — `05_bbn_grid.csv`

Chemin : `zz-data/chapter05/05_bbn_grid.csv`

| Colonne | Description                                     | Unité |
|:--------|:------------------------------------------------|:------|
| T_Gyr   | Grille log‑uniforme (1e−6 → 14)                 | Gyr   |

- Grille en T partagée avec `05_bbn_data.csv`, `05_bbn_invariants.csv`,
  `05_chi2_bbn_vs_T.csv` et `05_dchi2_vs_T.csv`.
- Densité contrôlée par un pas **Δlog10 T ≈ 0.01**.

### 3.3 Données modèle sur la grille — `05_bbn_data.csv`

Chemin : `zz-data/chapter05/05_bbn_data.csv`

| Colonne | Description                                | Unité |
|:--------|:-------------------------------------------|:------|
| T_Gyr   | Même grille que `05_bbn_grid.csv`          | Gyr   |
| DH_calc | Rapport D/H calculé                        | —     |
| Yp_calc | Abondance massique ⁴He calculée            | —     |

Ces colonnes constituent la base pour la construction des invariants et pour
les comparaisons modèle vs observations dans les figures 2 et 3.

### 3.4 Invariants adimensionnels — `05_bbn_invariants.csv`

Chemin : `zz-data/chapter05/05_bbn_invariants.csv`

| Colonne | Description                         | Unité |
|:--------|:------------------------------------|:------|
| T_Gyr   | Grille log‑uniforme                 | Gyr   |
| I_DH    | Invariant D/H (définition interne)  | —     |
| I_Yp    | Invariant Yp (définition interne)   | —     |

- Les définitions exactes des invariants sont documentées dans le texte LaTeX.
- Ce fichier peut être réutilisé par d’autres chapitres pour des comparaisons
  croisées sans recalculer la physique BBN.

-------------------------------------------------------------------------------
## 4. Données produites (autres fichiers & paramètres)

Cette section regroupe les fichiers de **sortie complémentaires**, essentiellement
les métriques χ², sa dérivée lissée et les paramètres de configuration consolidés.

### 4.1 Courbe χ²(T) — `05_chi2_bbn_vs_T.csv`

Chemin : `zz-data/chapter05/05_chi2_bbn_vs_T.csv`

| Colonne          | Description         | Unité |
|:-----------------|:--------------------|:------|
| T_Gyr            | Grille              | Gyr   |
| chi2_nucleosynth | χ² cumulée          | —     |

- χ² est construite à partir des jalons de `05_bbn_milestones.csv` et des
  prédictions issues de `05_bbn_data.csv`.

### 4.2 Dérivée lissée dχ²/dT — `05_dchi2_vs_T.csv`

Chemin : `zz-data/chapter05/05_dchi2_vs_T.csv`

| Colonne      | Description                      | Unité |
|:-------------|:---------------------------------|:------|
| T_Gyr        | Grille                           | Gyr   |
| dchi2_smooth | d(χ²)/dT lissée (Savitzky–Golay) | —/Gyr |

- La dérivée est typiquement calculée via un filtre **Savitzky–Golay** avec
  `window_length = 7`, `polyorder = 3` (valeurs à confirmer dans le code).

### 4.3 Paramètres consolidés — `05_bbn_params.json`

Chemin : `zz-data/chapter05/05_bbn_params.json`

Clés recommandées (exemple) :

- `T_min`, `T_max`, `n_points`
- `window_length`, `polyorder`
- `tol_primary`, `tol_order2`
- `max_epsilon_primary`, `max_epsilon_order2`

Ce fichier sert de **résumé de configuration** et de suivi des tolérances et
écarts maximaux pour assurer la cohérence inter‑chapitres.

-------------------------------------------------------------------------------
## 5. Figures générées (`zz-figures/chapter05/`)

- `05_fig_01_bbn_reaction_network.png`  
  Réseau de réactions BBN (schéma conceptuel).

- `05_fig_02_dh_model_vs_obs.png`  
  D/H modèle vs observations (éventuellement en log–log).

- `05_fig_03_yp_model_vs_obs.png`  
  Yp (⁴He) modèle vs observations (éventuellement en log–log).

- `05_fig_04_chi2_vs_t.png`  
  χ²(T) et, si souhaité, superposition de la dérivée lissée dχ²/dT.

Toutes les figures sont en **PNG**, résolution cible 300 dpi, style harmonisé
avec les autres chapitres (polices, palettes, labels).

-------------------------------------------------------------------------------
## 6. Scripts d’exécution (`zz-scripts/chapter05/`)

### 6.1 Génération des données — `generate_data_chapter05.py`

Script principal :

- Chemin : `zz-scripts/chapter05/generate_data_chapter05.py`
- Entrée logique : `05_bbn_milestones.csv` (et éventuelles constantes internes).
- Sorties :

  - `05_bbn_grid.csv`
  - `05_bbn_data.csv`
  - `05_bbn_invariants.csv`
  - `05_chi2_bbn_vs_T.csv`
  - `05_dchi2_vs_T.csv`
  - `05_bbn_params.json`

### 6.2 Tracé des figures

Scripts de tracé individuels :

- `plot_fig01_bbn_reaction_network.py`  
  → `05_fig_01_bbn_reaction_network.png`

- `plot_fig02_dh_model_vs_obs.py`  
  → `05_fig_02_dh_model_vs_obs.png`

- `plot_fig03_yp_model_vs_obs.py`  
  → `05_fig_03_yp_model_vs_obs.png`

- `plot_fig04_chi2_vs_T.py`  
  → `05_fig_04_chi2_vs_t.png`

-------------------------------------------------------------------------------
## 7. Paramètres & environnement (requirements.txt)

Fichier : `zz-scripts/chapter05/requirements.txt`

Contient la liste minimale (ou recommandée) des dépendances Python, par exemple :

- `numpy`
- `pandas`
- `scipy`
- `matplotlib`

La version de Python ciblée pour l’exécution de ces scripts est ≥ 3.10 (à aligner
sur la configuration globale du projet MCGT).

-------------------------------------------------------------------------------
## 8. Paramètres numériques & conventions

Constantes et conventions typiques utilisées dans ce chapitre (à confirmer dans
le code si évolutions ultérieures) :

- Grille en T (Gyr) log‑uniforme : `[1e-6, 14]` avec pas `Δlog10 T ≈ 0.01`.
- Lissage Savitzky–Golay pour dχ²/dT : `window_length = 7`, `polyorder = 3`.
- Tolérances de classification des jalons :  
  - **primaire** : écart relatif ≤ 1 % ;  
  - **ordre 2** : écart relatif ≤ 10 %.
- Échelle de dérivée pour les tracés : normalisation interne (unités sans dimension).

Ces conventions doivent rester cohérentes avec les chapitres 1–4 et avec les
paramètres consignés dans `05_bbn_params.json`.

-------------------------------------------------------------------------------
## 9. Contrôles qualité et validations

Quelques contrôles recommandés après génération des données :

- **Intégrité CSV**  
  - En‑têtes présents.  
  - Colonnes numériques parsables (`float`).  
  - Absence de doublons sur `label` dans `05_bbn_milestones.csv`.

- **Cohérence des séries**  
  - Même longueur de grille pour `05_bbn_grid.csv`, `05_bbn_data.csv`,
    `05_bbn_invariants.csv`, `05_chi2_bbn_vs_T.csv`, `05_dchi2_vs_T.csv`.  
  - Gestion explicite des NaN (dropna ou interpolation contrôlée).

- **Bornage et extrapolation**  
  - Pas d’extrapolation non contrôlée en dehors de `[T_min, T_max]`.  

- **Tolérances**  
  - Vérifier que les écarts relatifs associés aux jalons respectent les seuils
    définis pour `primary` et `order2` (cf. `05_bbn_params.json`).

- **Journalisation**  
  - Messages de diagnostic explicites en cas d’erreur (exceptions Python).  
  - Possibilité de niveau de verbosité (DEBUG/INFO) dans le script principal.

-------------------------------------------------------------------------------
## 10. Commandes d’exécution (depuis la racine du dépôt)

### 10.1 Génération des données du chapitre 5

```bash
python zz-scripts/chapter05/generate_data_chapter05.py
```

### 10.2 Tracé des figures

```bash
python zz-scripts/chapter05/plot_fig01_bbn_reaction_network.py
python zz-scripts/chapter05/plot_fig02_dh_model_vs_obs.py
python zz-scripts/chapter05/plot_fig03_yp_model_vs_obs.py
python zz-scripts/chapter05/plot_fig04_chi2_vs_T.py
```

-------------------------------------------------------------------------------
## 11. Compilation LaTeX

Compilation individuelle des sources LaTeX du chapitre :

```bash
pdflatex -jobname=chap5_conceptual  05-nucleosynthese-primordiale/05_primordial_nucleosynthesis_conceptual.tex
pdflatex -jobname=chap5_details     05-nucleosynthese-primordiale/05_primordial_nucleosynthesis_details.tex
```

Vérifier que les chemins vers `zz-figures/chapter05/` sont corrects dans les
fichiers `.tex` (inclure les quatre figures principales).

-------------------------------------------------------------------------------
## 12. Reproductibilité & manifestes

- Les fichiers de données et de figures du chapitre 5 doivent être référencés
  dans :  
  - `zz-manifests/manifest_master.json`  
  - `zz-manifests/manifest_publication.json`

- Les scripts et tables peuvent être soumis aux validateurs génériques du dépôt
  (par exemple `validate_json.py`, `validate_csv_table.py`) ainsi qu’aux tests
  CI dédiés.

- Toute modification des résultats BBN (tables ou figures) doit être :
  - associée à un commit clair ;  
  - documentée dans `CHANGELOG.md` si elle impacte les résultats publiés ;  
  - accompagnée, si nécessaire, d’une mise à jour des tolérances dans
    `05_bbn_params.json`.

