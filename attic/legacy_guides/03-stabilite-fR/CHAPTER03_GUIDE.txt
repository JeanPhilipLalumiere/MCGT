# CHAPITRE 3 — GUIDE D’UTILISATION
Stabilité de f(R)

Ce guide décrit, pour le Chapitre 3, la génération des données, la production des figures
et l’intégration LaTeX associées à l’étude de stabilité des modèles de gravité f(R).
Il suit la même structure que les guides des chapitres 1 et 2 afin d’homogénéiser la
présentation dans l’ensemble du projet MCGT.

---

## 1. Objet

L’objectif de ce chapitre est de documenter la **stabilité des modèles f(R)** via :

- la construction de jeux de données normalisés (domaines de stabilité, courbes Ricci, etc.) ;
- la production de figures de diagnostic (domaine (β, γ), masse scalaire, Ricci vs z/T, qualité de grille) ;
- l’intégration de ces résultats dans les textes LaTeX du chapitre conceptuel et détaillé.

Les conventions de nommage sont alignées sur le dépôt MCGT :
préfixe `03_` pour les données / scripts / figures de ce chapitre.

---

## 2. Organisation des fichiers

### 2.1 Sources LaTeX  (`03-stabilite-fR/`)

- `03_stabilite_fR_conceptuel.tex`
- `03_stabilite_fR_details.tex`
- `CHAPTER03_GUIDE.txt`  *(ce fichier)*

### 2.2 Données  (`zz-data/chapter03/`)

**Entrées principales (jalons et Ricci) :**

- `03_ricci_fR_milestones.csv`

**Tableaux produits (stabilité et Ricci) :**

- `03_fR_stability_data.csv`
- `03_fR_stability_domain.csv`
- `03_fR_stability_boundary.csv`
- `03_ricci_fR_vs_z.csv`
- `03_ricci_fR_vs_T.csv`

**Métadonnées :**

- `03_fR_stability_meta.json`

> Remarque : les noms ci-dessus sont donnés dans leur forme normalisée
> utilisée par le dépôt MCGT. Si des variantes anciennes subsistent
> (par ex. `03_stability_fR_*.csv`), elles sont considérées comme obsolètes.

### 2.3 Figures  (`zz-figures/chapter03/`)

- `03_fig_01_stability_fR_domain.png`
- `03_fig_02_fR_fRR_vs_R.png`
- `03_fig_03_ms2_R0_vs_R.png`
- `03_fig_04_fR_fRR_vs_R.png`
- `03_fig_05_milestones_interpolation.png`
- `03_fig_06_grid_quality.png`
- `03_fig_07_ricci_fR_vs_z.png`
- `03_fig_08_ricci_fR_vs_T.png`

Toutes les figures sont en PNG, résolution cible 300 dpi, style harmonisé avec
les autres chapitres (axes, police, palettes).

### 2.4 Scripts  (`zz-scripts/chapter03/`)

**Génération des données :**

- `generate_data_chapter03.py`

**Tracé des figures :**

- `plot_fig01_stability_fR_domain.py`
- `plot_fig02_fR_fRR_vs_R.py`
- `plot_fig03_ms2_R0_vs_R.py`
- `plot_fig04_fR_fRR_vs_R.py`
- `plot_fig05_milestones_interpolation.py`
- `plot_fig06_grid_quality.py`
- `plot_fig07_ricci_fR_vs_z.py`
- `plot_fig08_ricci_fR_vs_T.py`

**Environnement Python :**

- `requirements.txt`  *(dépendances spécifiques au chapitre 3, si présentes)*

> Les fichiers de sauvegarde (`*.bak`, `*.rescue*`, etc.) et les caches
> (`__pycache__/`) ne sont pas documentés ici : ils sont traités comme des
> artefacts internes/temporaires.

---

## 3. Données d’entrée

### 3.1 Jalons Ricci — `03_ricci_fR_milestones.csv`

Format CSV (séparateur virgule, encodage UTF‑8, sans index).

| Colonne    | Description                  | Unité | Remarques                         |
|:----------:|:----------------------------|:-----:|:----------------------------------|
| `R_over_R0`| Rapport \(R/R_0\)           |   —   | Points jalons de référence        |
| `f_R`      | Dérivée première \(f'(R)\)  |   —   | Valeurs exactes ou lissées       |
| `f_RR`     | Dérivée seconde \(f''(R)\)  |   —   | Valeurs exactes ou lissées       |

Ce fichier fournit la base de la reconstruction de la stabilité : les autres tables
sont dérivées de cette échelle en \(R/R_0\).

### 3.2 Paramètres globaux (configuration)

Les paramètres globaux du modèle (cosmologie, unités, constantes) sont définis dans :

- `zz-configuration/mcgt-global-config.ini`

Un sous-ensemble de paramètres de grille (par ex. taille de grille, bornes)
peut être lu par `generate_data_chapter03.py` selon les options implémentées.
Se référer aux commentaires dans le script pour la signification exacte des clés.

---

## 4. Données produites

### 4.1 Données de stabilité — `03_fR_stability_data.csv`

| Colonne        | Description                              | Unité | Remarques                               |
|:--------------:|:-----------------------------------------|:-----:|:----------------------------------------|
| `R_over_R0`    | Rapport \(R/R_0\)                        |   —   | Grille issue des jalons / densifiée    |
| `f_R`          | \(f'(R)\)                                |   —   | Interpolation (PCHIP sur \(\log_{10}\)) |
| `f_RR`         | \(f''(R)\)                               |   —   | Interpolation (PCHIP sur \(\log_{10}\)) |
| `m_s2_over_R0` | Masse scalaire normalisée \(m_s^2/R_0\)  |   —   | \((f_R - (R/R_0)\,f_{RR})/(3\,f_{RR})\) |

### 4.2 Domaine de stabilité — `03_fR_stability_domain.csv`

| Colonne    | Description                       | Unité | Remarques                         |
|:----------:|:----------------------------------|:-----:|:----------------------------------|
| `beta`     | Paramètre adimensionnel \(\beta\) |   —   | Grille de stabilité               |
| `gamma_min`| \(\gamma_{\min}\)                |   —   | Contrainte physique (≥ 0)         |
| `gamma_max`| \(\gamma_{\max}\)                |   —   | Dérivée de `m_s2_over_R0`         |

### 4.3 Frontière de stabilité — `03_fR_stability_boundary.csv`

| Colonne      | Description                         | Unité | Remarques                      |
|:------------:|:------------------------------------|:-----:|:-------------------------------|
| `beta`       | Paramètre \(\beta\)                 |   —   | Même échantillonnage que 4.2   |
| `gamma_limit`| Frontière \(\gamma\) (stabilité max)|   —   | Typiquement \(\gamma_{\max}\)  |

### 4.4 Ricci vs décalage spectral — `03_ricci_fR_vs_z.csv`

| Colonne     | Description              | Unité | Remarques                        |
|:-----------:|:-------------------------|:-----:|:---------------------------------|
| `R_over_R0` | Rapport \(R/R_0\)        |   —   | Même jalons / grille             |
| `f_R`       | \(f'(R)\)                |   —   | Interpolé                        |
| `f_RR`      | \(f''(R)\)               |   —   | Interpolé                        |
| `z`         | Décalage spectral        |   —   | Interpolation monotone (PCHIP)   |

### 4.5 Ricci vs temps cosmique — `03_ricci_fR_vs_T.csv`

| Colonne     | Description                 | Unité | Remarques                             |
|:-----------:|:----------------------------|:-----:|:--------------------------------------|
| `R_over_R0` | Rapport \(R/R_0\)           |   —   | Même jalons                           |
| `f_R`       | \(f'(R)\)                   |   —   | Interpolé                             |
| `f_RR`      | \(f''(R)\)                  |   —   | Interpolé                             |
| `T_Gyr`     | Âge de l’Univers            | Gyr   | Interpolation log–log (extrap. limitée)|

### 4.6 Métadonnées — `03_fR_stability_meta.json`

Objet JSON contenant au minimum :

- `n_points` : taille de grille principale ;
- `files` : liste des fichiers produits associés à ce chapitre ;
- éventuellement d’autres champs de traçabilité (horodatage, hash, version).

---

## 5. Figures générées

Les figures standard sont :

- `03_fig_01_stability_fR_domain.png` : domaine de stabilité \((\beta, \gamma)\).
- `03_fig_02_fR_fRR_vs_R.png` : diagnostics de \(f'(R)\) et \(f''(R)\) vs \(R/R_0\).
- `03_fig_03_ms2_R0_vs_R.png` : \(m_s^2/R_0\) vs \(R/R_0\).
- `03_fig_04_fR_fRR_vs_R.png` : second diagnostic \(f'(R)\), \(f''(R)\) (autre échelle ou zoom).
- `03_fig_05_milestones_interpolation.png` : comparaison jalons vs interpolation.
- `03_fig_06_grid_quality.png` : qualité de la grille (pas log10, uniformité, outliers).
- `03_fig_07_ricci_fR_vs_z.png` : \(f'(R)\), \(f''(R)\) vs z.
- `03_fig_08_ricci_fR_vs_T.png` : \(f'(R)\), \(f''(R)\) vs \(T\) (Gyr).

Objectif visuel : montrer clairement où le modèle est stable/instable, et comment les observables
évoluent en fonction du temps et du décalage spectral.

---

## 6. Scripts & exécution

### 6.1 Génération des données

Commande typique (à adapter aux options disponibles dans le script actuel) :

```bash
python zz-scripts/chapter03/generate_data_chapter03.py
```

Selon la version du script, des options comme `--npts`, `--config` ou
`--overwrite` peuvent exister. Se référer à l’en-tête de `generate_data_chapter03.py`
pour la liste exacte des arguments.

### 6.2 Tracé des figures

```bash
python zz-scripts/chapter03/plot_fig01_stability_fR_domain.py
python zz-scripts/chapter03/plot_fig02_fR_fRR_vs_R.py
python zz-scripts/chapter03/plot_fig03_ms2_R0_vs_R.py
python zz-scripts/chapter03/plot_fig04_fR_fRR_vs_R.py
python zz-scripts/chapter03/plot_fig05_milestones_interpolation.py
python zz-scripts/chapter03/plot_fig06_grid_quality.py
python zz-scripts/chapter03/plot_fig07_ricci_fR_vs_z.py
python zz-scripts/chapter03/plot_fig08_ricci_fR_vs_T.py
```

### 6.3 Environnement Python

Les dépendances spécifiques (NumPy, SciPy, matplotlib, etc.) sont listées dans :

- `zz-scripts/chapter03/requirements.txt`

Installation recommandée dans un environnement virtuel dédié :

```bash
pip install -r zz-scripts/chapter03/requirements.txt
```

---

## 7. Paramètres & conventions

- **Grille en \(R/R_0\)** : induite par les jalons de `03_ricci_fR_milestones.csv`,
  éventuellement densifiée par le script de génération.
- **Interpolation** : PCHIP appliqué sur \(\log_{10} f_R\) et \(\log_{10} f_{RR}\)
  afin de limiter les oscillations non physiques.
- **Contraintes de stabilité** :
  - \(\gamma_{\min} \ge 0\) ;
  - \(\gamma_{\max}\) dérivée de `m_s2_over_R0` ;
  - domaine exploitable borné par des critères numériques (absence de NaN/inf, etc.).
- **Formats** :
  - CSV : séparateur `,`, encodage UTF‑8, point décimal `.` ;
  - JSON : valide, sans commentaires, UTF‑8.

---

## 8. Contrôles de qualité & tests

### 8.1 Tests locaux

- Vérifier que toutes les tables produites sont **sans NaN ni inf** dans les colonnes clés
  (`f_R`, `f_RR`, `m_s2_over_R0`, `beta`, `gamma_min`, `gamma_max`, etc.).
- Inspecter visuellement `03_fig_06_grid_quality.png` pour détecter :
  - des pas de grille anormaux ;
  - des trous ou regroupements exagérés dans la grille log10.

### 8.2 Schémas & validateurs

Schémas JSON / CSV (emplacement indicatif, à adapter) :

- `zz-schemas/meta_schema.json` → pour `03_fR_stability_meta.json` ;
- `zz-schemas/comparison_milestones_table_schema.json` → pour les tables de jalons / Ricci.

Exemples de validations (si les scripts génériques existent dans le dépôt) :

```bash
python zz-schemas/validate_json.py zz-schemas/meta_schema.json \
    zz-data/chapter03/03_fR_stability_meta.json

python zz-schemas/validate_csv_table.py \
    zz-schemas/comparison_milestones_table_schema.json \
    zz-data/chapter03/03_ricci_fR_milestones.csv
```

### 8.3 Intégration dans la CI

Les tests globaux (schémas, manifests, etc.) peuvent inclure :

- `zz-tests/test_schemas.py`
- `zz-tests/test_manifest.py`

afin de garantir que les nouveaux fichiers du chapitre 3 respectent la structure
attendue et sont bien déclarés dans les manifests.

---

## 9. Intégration LaTeX

Compilation conseillée des documents du chapitre 3 :

```bash
pdflatex -jobname=chap3_conceptuel 03-stabilite-fR/03_stabilite_fR_conceptuel.tex
pdflatex -jobname=chap3_details    03-stabilite-fR/03_stabilite_fR_details.tex
```

Les chemins vers les figures doivent pointer vers `zz-figures/chapter03/` avec
les noms normalisés `03_fig_*.png`.

---

## 10. Journalisation & traçabilité

- **Manifestes de chapitre** :
  - `zz-manifests/chapters/chapter_manifest_03.json` :
    déclare l’ensemble des fichiers de données, figures et scripts.
- **Rapports automatiques** (si présents) :
  - `zz-manifests/reports/` : rapports de diagnostic globaux.
- **Métadonnées internes** :
  - `zz-data/chapter03/03_fR_stability_meta.json` : contient les informations
    minimales nécessaires à la traçabilité des productions du chapitre 3.

La mise à jour de ce guide doit être accompagnée de commits cohérents dans Git,
avec un message décrivant explicitement les changements apportés aux scripts,
aux données et aux manifests du chapitre 3.
