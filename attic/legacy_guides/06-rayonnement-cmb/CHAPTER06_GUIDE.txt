CHAPITRE 6 – RAYONNEMENT CMB — GUIDE D’UTILISATION
======================================================

Objectif
--------
Ce guide décrit de manière complète la génération des données, la production
des figures, l’injection MCGT dans CAMB et la compilation LaTeX pour le
Chapitre 6 (Rayonnement CMB) du projet MCGT. Toutes les étapes et fichiers
sont référencés en suivant exactement l’état actuel du dépôt MCGT
(zz-data/chapter06/, zz-figures/chapter06/, zz-scripts/chapter06/).

Les noms de fichiers sont en anglais pour rester cohérents avec le reste
du projet, même si le texte du guide est en français.

Dépendances logicielles minimales
---------------------------------
- Python ≥ 3.10 (tests courants sous Python 3.12)
  - numpy, pandas, scipy, matplotlib
  - éventuels modules internes MCGT (import mcgt, etc.)
- CAMB (API Python, et binaire `camb` optionnel)
  - dépendances système usuelles : FFTW, GSL, BLAS/LAPACK (selon l’installation)
- LaTeX / pdflatex
  - packages usuels : amsmath, graphicx, siunitx, booktabs, hyperref, adjustbox

1) Organisation des fichiers
----------------------------

1.1 Sources LaTeX (dossier : `06-rayonnement-cmb/`)
- 06_cmb_conceptuel.tex
- 06_cmb_details.tex
- CHAPTER06_GUIDE.txt  ← le présent guide

1.2 Données (dossier : `zz-data/chapter06/`)
- 06_cls_spectrum_lcdm.dat
- 06_cls_spectrum.dat
- 06_cmb_full_results.csv
- 06_cmb_chi2_scan2D.csv
- 06_delta_cls.csv
- 06_delta_cls_relative.csv
- 06_delta_rs_scan.csv
- 06_delta_rs_scan2D.csv
- 06_delta_rs_scan_full.csv
- 06_delta_Tm_scan.csv   (optionnel / diagnostique)
- 06_hubble_mcgt.dat
- 06_alpha_evolution.csv (optionnel, export A_s et n_s en fonction de α)
- 06_params_cmb.json
- 01_P_vs_T.dat          (copie de la grille P(T) utilisée par d’autres chapitres)

1.3 Figures (dossier : `zz-figures/chapter06/`)
- 06_fig_01_cmb_dataflow_diagram.png
- 06_fig_02_cls_lcdm_vs_mcgt.png
- 06_fig_03_delta_cls_relative.png
- 06_fig_04_delta_rs_vs_params.png
- 06_fig_05_delta_chi2_heatmap.png

1.4 Scripts (dossier : `zz-scripts/chapter06/`)
- generate_pdot_plateau_vs_z.py
- generate_data_chapter06.py
- plot_fig01_cmb_dataflow_diagram.py
- plot_fig02_cls_lcdm_vs_mcgt.py
- plot_fig03_delta_cls_relative.py
- plot_fig04_delta_rs_vs_params.py
- plot_fig05_delta_chi2_heatmap.py
- requirements.txt
- run_camb_chapter06.bat  (optionnel, exécution CAMB en local sous Windows)

2) Données d’entrée principales (formats)
-----------------------------------------

2.1 Fichier : `zz-data/chapter06/06_cls_spectrum_lcdm.dat`

Table ASCII (format CAMB) pour le spectre de référence ΛCDM.

- Colonnes :
  - ell      : multipôle (ℓ = 2…3000 typiquement)
  - Cl_LCDM  : spectre C_ℓ^{ΛCDM} en µK²

En-tête attendu (première ligne, commentaire) :
- `# ell   Cl_LCDM`

Ce fichier peut être produit soit par un appel direct à CAMB (binaire `camb`),
soit par l’API Python dans `generate_data_chapter06.py`.

2.2 Fichier : `zz-data/chapter06/06_cls_spectrum.dat`

Spectre CMB calculé pour le modèle MCGT.

- Colonnes :
  - ell      : multipôle (même grille que 06_cls_spectrum_lcdm.dat)
  - Cl_MCGT  : spectre C_ℓ^{MCGT} en µK²

En-tête attendu :
- `# ell   Cl_MCGT`

2.3 Fichier : `zz-data/chapter06/06_hubble_mcgt.dat`

Loi d’expansion MCGT injectée dans CAMB.

- Colonnes typiques :
  - z          : redshift
  - H_over_H0  : H(z)/H0 (ou rapport H_model(z)/H_LCDM(z), selon configuration)

Commentaire d’en-tête de référence (indicatif) :
- `# z   H_model(z)/H_LCDM(z)`

Ce fichier est produit par `generate_pdot_plateau_vs_z.py` et sert d’entrée
à CAMB (API Python ou binaire), via un paramètre de type `expansion_rate_file`.

2.4 Fichier : `zz-data/chapter06/06_cmb_full_results.csv`

Tableau agrégé regroupant les principaux résultats CMB par multipôle ℓ.

- Contenu :
  - au minimum : ell, Cl_LCDM, Cl_MCGT, delta_Cl, delta_Cl_rel
  - éventuellement d’autres colonnes dérivées (poids, masques, etc.)

Remarque : la structure exacte est donnée par l’en-tête du fichier.
Ce CSV est produit par `generate_data_chapter06.py` et sert de base à
plusieurs figures et diagnostics.

2.5 Fichier : `zz-data/chapter06/06_params_cmb.json`

Fichier de métadonnées et de paramètres de run pour le Chapitre 6.

Exemple de contenu (illustratif) :
{
  "alpha": 0.2,
  "q0star": -0.1,
  "ell_min": 2,
  "ell_max": 3000,
  "n_points": 3001,
  "thresholds": { "primary": 0.01, "order2": 0.1 },
  "derivative_window": 7,
  "derivative_polyorder": 3,
  "H0": 67.36,
  "ombh2": 0.02237,
  "omch2": 0.12,
  "tau": 0.0544,
  "mnu": 0.06,
  "As0": 2.1e-09,
  "ns0": 0.9649,
  "c1": 0.10,
  "c2": 0.01,
  "max_delta_Cl_rel": 0.6296832401981298
}

Les valeurs numériques varient selon le run, mais la structure clé/valeur
reste stable et permet la reproductibilité (paramètres cosmologiques,
seuils, taille de grille, etc.).

3) Données produites et diagnostics (CMB)
-----------------------------------------

3.1 Fichier : `zz-data/chapter06/06_delta_cls.csv`

Différence absolue entre les spectres MCGT et ΛCDM.

- Colonnes :
  - ell      : multipôle
  - delta_Cl : ΔC_ℓ = C_ℓ^{MCGT} − C_ℓ^{ΛCDM}  (en µK²)

En-tête recommandé :
- `ell,delta_Cl`

3.2 Fichier : `zz-data/chapter06/06_delta_cls_relative.csv`

Différence relative entre les spectres MCGT et ΛCDM.

- Colonnes :
  - ell          : multipôle
  - delta_Cl_rel : (C_ℓ^{MCGT} − C_ℓ^{ΛCDM}) / C_ℓ^{ΛCDM}

En-tête recommandé :
- `ell,delta_Cl_rel`

Ce fichier est utilisé pour les diagnostics de stabilité et pour les figures
de type ΔC_ℓ/C_ℓ.

3.3 Fichiers : `06_delta_rs_scan.csv`, `06_delta_rs_scan2D.csv`, `06_delta_rs_scan_full.csv`

Variation relative de la longueur de traînée baryonique r_s en fonction
des paramètres (α, q0star).

- 06_delta_rs_scan.csv (profil 1D) :
  - colonnes typiques : q0star, r_s, delta_rs_rel
  - q0star : valeur de q0* testée
  - r_s : r_drag(q0*) en Mpc
  - delta_rs_rel : (r_s − r_ref)/r_ref

- 06_delta_rs_scan2D.csv (carte 2D) :
  - colonnes typiques : alpha, q0star, r_s, delta_rs_rel
  - alpha : paramètre de modulation du spectre primordial
  - q0star : paramètre de courbure effective
  - r_s, delta_rs_rel : comme ci-dessus

- 06_delta_rs_scan_full.csv :
  - version détaillée du scan (grille complète, éventuellement multi-runs)
  - colonnes cohérentes avec les fichiers précédents
  - sert de base aux agrégations/figures (Δr_s/r_s vs paramètres)

3.4 Fichier : `zz-data/chapter06/06_cmb_chi2_scan2D.csv`

Carte 2D de χ²(α, q0star) construite à partir des spectres C_ℓ.

- Colonnes typiques :
  - alpha : paramètre α
  - q0star : paramètre q0*
  - chi2 : Σ_ℓ [(C_ℓ^{MCGT} − C_ℓ^{ΛCDM})² / C_ℓ^{ΛCDM}]

Ce fichier alimente la figure de heatmap (χ² en fonction de α et q0*).

3.5 Fichier : `zz-data/chapter06/06_delta_Tm_scan.csv` (optionnel)

Diagnostics sur le transfert de matière T_m(k).

- Colonnes typiques :
  - k        : vecteur d’onde (h/Mpc)
  - delta_Tm : ΔT_m(k) = T_m^{MCGT}(k) − T_m^{ΛCDM}(k)

Ce fichier est utile pour analyser l’impact MCGT sur les transferts
de matière en complément des seuls spectres CMB.

3.6 Fichier : `zz-data/chapter06/06_alpha_evolution.csv` (si export activé)

Suivi de la modulation du spectre primordial en fonction de α.

- Colonnes typiques :
  - alpha : paramètre de modulation
  - As    : amplitude scalaire A_s(α)
  - ns    : indice spectral n_s(α)

Modèle (petites variations) :
- As(α) = As0 · (1 + c1·α)
- ns(α) = ns0 + c2·α

Les coefficients As0, ns0, c1, c2 sont enregistrés dans 06_params_cmb.json.

3.7 Fichier : `zz-data/chapter06/01_P_vs_T.dat`

Copie de la grille P(T) utilisée dans d’autres chapitres (01, 04, etc.).

- Colonnes typiques :
  - T_Gyr : âge propre (Gyr)
  - P     : quantité P(T) (définie dans les chapitres 1–2)

Ce fichier est rangé dans chapter06 pour faciliter certains contrôles
inter-chapitres, mais sa définition principale reste documentée dans
le guide du Chapitre 1.

4) Figures générées (zz-figures/chapter06/)
-------------------------------------------

- 06_fig_01_cmb_dataflow_diagram.png
  Schéma global du flux de données :
  expansion MCGT (H(z)) → CAMB → spectres C_ℓ → ΔC_ℓ, Δr_s, χ².

- 06_fig_02_cls_lcdm_vs_mcgt.png
  Comparaison des spectres C_ℓ^{ΛCDM} et C_ℓ^{MCGT}.
  Échelles adaptées, annotations sur les paramètres (α, q0star).

- 06_fig_03_delta_cls_relative.png
  ΔC_ℓ/C_ℓ en fonction de ℓ (diagnostic relatif, bande ±10 %, etc.).

- 06_fig_04_delta_rs_vs_params.png
  Δr_s/r_s en fonction de q0* (et éventuellement de α),
  avec lignes de référence (±1 %, seuils Planck/BAO, etc.).

- 06_fig_05_delta_chi2_heatmap.png
  Carte 2D de χ²(α, q0star) à partir de 06_cmb_chi2_scan2D.csv.

5) Scripts d’exécution et pipeline recommandé
---------------------------------------------

5.1 Préparation de H(z) MCGT

Script : `zz-scripts/chapter06/generate_pdot_plateau_vs_z.py`

- Rôle :
  - Construire la loi d’expansion MCGT H(z)/H0 conforme au plateau
    temporel du modèle.
  - Écrire `zz-data/chapter06/06_hubble_mcgt.dat`.
- Entrées :
  - paramètres globaux du modèle (fichier de configuration MCGT, etc.)
  - éventuellement la grille P(T) (01_P_vs_T.dat) pour assurer la cohérence.

Ce script est à lancer avant CAMB / generate_data_chapter06.py dès que
les paramètres globaux changent.

5.2 Injection MCGT dans CAMB (optionnel, mode CLI)

En plus de l’API Python, on peut utiliser le binaire `camb` avec un fichier
d’expansion :

Exemple de commande :

camb zz-configuration/camb_exact_plateau.ini \
  output_root=mcgt_cmb \
  expansion_rate_file=zz-data/chapter06/06_hubble_mcgt.dat

- `camb_exact_plateau.ini` contient la configuration CAMB standard
  (cosmologie fiducielle, options de sortie, etc.).
- `expansion_rate_file` pointe vers 06_hubble_mcgt.dat.

Le script `run_camb_chapter06.bat` encapsule une commande de ce type
pour un environnement Windows.

5.3 Pipeline principal : génération des données CMB

Script : `zz-scripts/chapter06/generate_data_chapter06.py`

- Rôle :
  - Charger H(z) (06_hubble_mcgt.dat) et les paramètres cosmologiques.
  - Appeler CAMB via l’API Python.
  - Générer :
    - 06_cls_spectrum_lcdm.dat
    - 06_cls_spectrum.dat
    - 06_cmb_full_results.csv
    - 06_delta_cls.csv
    - 06_delta_cls_relative.csv
    - 06_delta_rs_scan.csv
    - 06_delta_rs_scan2D.csv
    - 06_delta_rs_scan_full.csv
    - 06_cmb_chi2_scan2D.csv
    - 06_delta_Tm_scan.csv (si activé)
    - 06_alpha_evolution.csv (si activé)
    - 06_params_cmb.json

- Interface CLI typique :
  - --alpha <float>   (ex. 0.20)
  - --q0star <float>  (ex. -0.10)
  - [--export-derivative]  (options supplémentaires éventuelles)

5.4 Scripts de tracé des figures

- `plot_fig01_cmb_dataflow_diagram.py`
  - Entrées : 06_params_cmb.json (pour annoter α, q0star, etc.).
  - Sortie : 06_fig_01_cmb_dataflow_diagram.png.

- `plot_fig02_cls_lcdm_vs_mcgt.py`
  - Entrées : 06_cls_spectrum_lcdm.dat, 06_cls_spectrum.dat.
  - Sortie : 06_fig_02_cls_lcdm_vs_mcgt.png.

- `plot_fig03_delta_cls_relative.py`
  - Entrées : 06_delta_cls_relative.csv.
  - Sortie : 06_fig_03_delta_cls_relative.png.

- `plot_fig04_delta_rs_vs_params.py`
  - Entrées : 06_delta_rs_scan.csv, 06_delta_rs_scan2D.csv (et/ou 06_delta_rs_scan_full.csv).
  - Sortie : 06_fig_04_delta_rs_vs_params.png.

- `plot_fig05_delta_chi2_heatmap.py`
  - Entrées : 06_cmb_chi2_scan2D.csv.
  - Sortie : 06_fig_05_delta_chi2_heatmap.png.

6) Paramètres, interpolations et lissages
-----------------------------------------

Constantes et tolérances typiques
- Lissage Savitzky–Golay :
  - fenêtre = 7 points
  - ordre du polynôme = 3
- Tolérances :
  - jalons « primaires » : écart relatif ≤ 1 %
  - jalons « ordre 2 » : écart relatif ≤ 10 %
- Dérivées tracées :
  - souvent renormalisées (÷1×10^4) pour la lisibilité.

Grilles et interpolations
- Grille multipôles ℓ :
  - ℓ ∈ [2, 3000]
  - discrétisation pouvant être log-uniforme (Δlog10 ℓ ≈ 0,01) selon les besoins.
- Interpolation C_ℓ :
  - PCHIP sur (log10 ℓ, log10 C_ℓ)
  - extrapolation limitée, puis clip aux bornes de la grille.
- Lissage :
  - Savitzky–Golay (fenêtre 7, ordre 3, mode='interp') pour lisser
    certaines dérivées ou courbes χ² si nécessaire.

Paramétrisation du spectre primordial
- Référence Planck 2018 :
  - A_s^0 ≈ 2.10×10^−9
  - n_s^0 ≈ 0.9649
- Modèle linéaire (petites variations) :
  - A_s(α) = A_s^0 · (1 + c1·α)
  - n_s(α) = n_s^0 + c2·α
- Les coefficients (c1, c2, A_s^0, n_s^0) sont consignés
  dans 06_params_cmb.json et, si l’export est activé, les valeurs
  correspondantes figurent dans 06_alpha_evolution.csv.

7) Contrôles de qualité (QC)
----------------------------

Avant d’utiliser les résultats du Chapitre 6 dans le manuscrit, vérifier :

- Intégrité des fichiers :
  - aucun fichier vide ;
  - absence de NaN/Inf dans les colonnes numériques ;
  - cohérence entre les longueurs de grilles (ℓ, z, etc.).

- Bornes relatives :
  - max |ΔC_ℓ / C_ℓ| < 10 % sur le domaine principal ;
  - pour les multipôles considérés comme « primaires », viser < 1 %.

- χ² :
  - valeurs finies et ≥ 0 ;
  - existence d’un minimum cohérent dans 06_cmb_chi2_scan2D.csv
    (région de paramètres compatibles avec les contraintes CMB).

- Cohérence inter-fichiers :
  - même plage de ℓ entre 06_cls_spectrum_lcdm.dat,
    06_cls_spectrum.dat, 06_delta_cls.csv, 06_delta_cls_relative.csv ;
  - même grille de paramètres (α, q0star) entre
    06_delta_rs_scan2D.csv et 06_cmb_chi2_scan2D.csv.

- Journalisation :
  - conserver les logs d’exécution (stdout/stderr) lors des runs majeurs
    de generate_data_chapter06.py ;
  - noter les valeurs-clés dans le CHANGELOG ou dans 06_params_cmb.json
    (seuils, fenêtres de lissage, etc.).

8) Commandes d’exécution (récapitulatif)
----------------------------------------

Toutes les commandes ci-dessous sont à lancer depuis la racine du projet MCGT.

8.1 Générer la loi d’expansion H(z) MCGT

python zz-scripts/chapter06/generate_pdot_plateau_vs_z.py

8.2 (Optionnel) Lancer CAMB en CLI avec l’expansion injectée

camb zz-configuration/camb_exact_plateau.ini \
  output_root=mcgt_cmb \
  expansion_rate_file=zz-data/chapter06/06_hubble_mcgt.dat

8.3 Pipeline complet (données CMB + méta)

python zz-scripts/chapter06/generate_data_chapter06.py \
  --alpha 0.20 \
  --q0star -0.10 \
  --export-derivative

Adapter évidemment les valeurs de α et q0star aux runs à documenter.

8.4 Tracé des figures

python zz-scripts/chapter06/plot_fig01_cmb_dataflow_diagram.py
python zz-scripts/chapter06/plot_fig02_cls_lcdm_vs_mcgt.py
python zz-scripts/chapter06/plot_fig03_delta_cls_relative.py
python zz-scripts/chapter06/plot_fig04_delta_rs_vs_params.py
python zz-scripts/chapter06/plot_fig05_delta_chi2_heatmap.py

9) Compilation LaTeX du Chapitre 6
----------------------------------

Compilation des deux sources LaTeX du chapitre (mode local, depuis la racine) :

pdflatex -interaction=nonstopmode 06-rayonnement-cmb/06_cmb_conceptuel.tex
pdflatex -interaction=nonstopmode 06-rayonnement-cmb/06_cmb_details.tex

Selon la configuration locale, il peut être nécessaire d’exécuter pdflatex
deux fois pour stabiliser les références internes.

10) Traçabilité et manifestes
-----------------------------

- Fichier 06_params_cmb.json :
  - centralise les paramètres de chaque run (α, q0star, grilles, seuils, etc.) ;
  - permet de reconstruire les conditions exactes d’un calcul.

- Manifestes :
  - zz-manifests/manifest_master.json
  - zz-manifests/manifest_publication.json
  Ces fichiers doivent référencer les données et figures essentielles du
  Chapitre 6 (listées en 1.2 et 1.3), avec les chemins et tailles corrects.

- Intégration CI :
  - les tests et validations génériques (schemas, manifests, etc.)
    couvrent aussi les fichiers de chapter06 ;
  - en cas de modification significative des résultats, mettre à jour
    éventuels CHANGELOG / notes de version associés au projet.

Ce guide doit permettre de reproduire et d’auditer de manière fiable
l’ensemble de la chaîne CMB du Chapitre 6 à partir du dépôt MCGT actuel.

